<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Wars Navigation Chart</title>

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

    <!-- Turf.js -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <!-- Custom styles -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="./style.css" type="text/css">
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="search-container">
        <div class="search-input-wrapper">
            <input type="text" id="search-input" placeholder="Search a system" onmouseover="showSmallTooltip(event, 'Search for a system')" onmouseout="hideTooltip()">
            <button id="search-button" onmouseover="showSmallTooltip(event, 'Search for a system')" onmouseout="hideTooltip()">
                <i class="target-circle-icon"></i>
            </button>
            <div id="suggestions-container"></div>
        </div>
        <div class="toggle-background-container">
            <button id="toggle-background" onmouseover="showSmallTooltip(event, 'Switch the background')" onmouseout="hideTooltip()"><i class="fas fa-star"></i></button>
        </div>
    </div>

    <script src="tools/search.js"></script>
    <script src="tools/tooltip.js"></script>
    <script type="module">
        import { setupBackgroundToggle } from './tools/toggleBackground.js';

        mapboxgl.accessToken = 'pk.eyJ1IjoibmVzcCIsImEiOiJjbHg1dDE5Mm4xY2h5Mmlxc2R2Mm95Y3ByIn0.Kp1Lcr9XD_u6oy8QOpvOZQ';

        // Function to initialize the map
        async function initializeMap() {
            try {
                // Fetch the layers list
                const layersResponse = await fetch('./layers/layers.json');
                const layers = await layersResponse.json();

                // Initialize the map
                const map = new mapboxgl.Map({
                    container: 'map',
                    style: {
                        version: 8,
                        sources: layers.sources,
                        layers: layers.layers
                    },
                    center: [0.00847486, -0.0109944],
                    zoom: 18
                });

                // Load features from systems.geojson once the map is loaded
                map.on('load', async () => {
                    try {
                        const systemsResponse = await fetch('./layers/systems.geojson');
                        const data = await systemsResponse.json();

                        // Add a layer to display the systems
                        map.addLayer({
                            'id': 'systems-layer',
                            'type': 'circle',
                            'source': {
                                'type': 'geojson',
                                'data': data
                            },
                            'paint': {
                                'circle-radius': 6,
                                'circle-color': 'rgba(255, 0, 0, 0)' // Transparent points
                            }
                        });

                        map.on('mouseenter', 'systems-layer', (event) => {
                            const feature = event.features[0];
                            const properties = feature.properties;
                            showTooltip(event.originalEvent, properties); // Use originalEvent to get correct coordinates
                        });

                        map.on('mouseleave', 'systems-layer', () => hideTooltip());

                        map.on('click', 'systems-layer', (event) => {
                            const feature = event.features[0];
                            const coordinates = feature.geometry.coordinates.slice();
                            const properties = feature.properties;

                            const imageTag = properties.picture ? `<img src="${properties.picture}" alt="System Image" class="popup-image">` : '';
                            const popupContent = `<div class="popup">
                                                    ${imageTag}
                                                    <div class="popup-info">
                                                        <h3>${properties.NAME}</h3>
                                                        ${properties.url_wookie ? `<p><a href="${properties.url_wookie}" target="_blank">More Info</a></p>` : ''}
                                                    </div>
                                                </div>`;

                            const popup = new mapboxgl.Popup({
                                closeButton: true,
                                closeOnClick: false,
                                anchor: 'bottom',
                                offset: 25,
                                maxWidth: 'none' // Allow popup to expand based on content
                            }).setLngLat(coordinates).setHTML(popupContent).addTo(map);

                            // Close popup when clicking anywhere else on the map
                            map.once('click', () => popup.remove());
                        });
                    } catch (error) {
                        console.error('Error loading systems data:', error);
                    }
                });

                // Setup background toggle
                setupBackgroundToggle(map);
            } catch (error) {
                console.error('Error loading layers:', error);
            }
        }

        // Initialize the map
        initializeMap();
    </script>
</body>
</html>
