<!-- Graphlib -->
<script src="https://unpkg.com/graphlib@2.1.8/dist/graphlib.min.js"></script>

<!-- Routing functionality -->
<script>
    var routeLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
            url: './layers/routes.geojson',
            format: new ol.format.GeoJSON()
        }),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'blue',
                width: 2
            })
        })
    });

    map.addLayer(routeLayer);

    var routeFeatureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'blue',
                width: 2
            })
        })
    });

    map.addLayer(routeFeatureOverlay);

    var startPoint, endPoint;
    var routingActive = false;

    document.getElementById('toggle-routing').addEventListener('click', function() {
        routingActive = !routingActive;
        this.style.backgroundColor = routingActive ? '#79aaca' : 'rgba(0, 0, 0, 0.8)';
        if (routingActive) {
            map.once('click', function(event) {
                startPoint = event.coordinate;
                console.log('Start node:', startPoint);

                map.once('click', function(event) {
                    endPoint = event.coordinate;
                    console.log('End node:', endPoint);
                    calculateAndDisplayRoute();
                });
            });
        }
    });

    function calculateAndDisplayRoute() {
        if (!startPoint || !endPoint) {
            alert('Please select both start and end points.');
            return;
        }

        var startProj = ol.proj.toLonLat(startPoint);
        var endProj = ol.proj.toLonLat(endPoint);

        var graph = new graphlib.Graph();

        routeLayer.getSource().forEachFeature(function(feature) {
            var geometry = feature.getGeometry();
            var coordinates = geometry.getCoordinates();

            for (var i = 0; i < coordinates.length - 1; i++) {
                var start = ol.proj.toLonLat(coordinates[i]);
                var end = ol.proj.toLonLat(coordinates[i + 1]);
                var distance = ol.sphere.getDistance(start, end);

                graph.setEdge(JSON.stringify(start), JSON.stringify(end), distance);
                graph.setEdge(JSON.stringify(end), JSON.stringify(start), distance);
            }
        });

        var path = dijkstra(graph, JSON.stringify(startProj), JSON.stringify(endProj));
        if (!path) {
            alert('No route found between the selected points.');
            return;
        }

        var routeFeature = new ol.Feature({
            geometry: new ol.geom.LineString(path.map(ol.proj.fromLonLat))
        });

        routeFeatureOverlay.getSource().clear();
        routeFeatureOverlay.getSource().addFeature(routeFeature);
    }

    function dijkstra(graph, start, end) {
        var distances = {};
        var predecessors = {};
        var queue = new Set(graph.nodes());

        distances[start] = 0;
        queue.forEach(function(node) {
            if (node !== start) distances[node] = Infinity;
        });

        while (queue.size > 0) {
            var minNode = [...queue].reduce((min, node) => distances[node] < distances[min] ? node : min);
            queue.delete(minNode);

            if (minNode === end) {
                var path = [];
                while (predecessors[minNode]) {
                    path.push(JSON.parse(minNode));
                    minNode = predecessors[minNode];
                }
                path.push(JSON.parse(start));
                return path.reverse();
            }

            graph.successors(minNode).forEach(function(neighbor) {
                var alt = distances[minNode] + graph.edge(minNode, neighbor);
                if (alt < distances[neighbor]) {
                    distances[neighbor] = alt;
                    predecessors[neighbor] = minNode;
                }
            });
        }

        return null;
    }
</script>
