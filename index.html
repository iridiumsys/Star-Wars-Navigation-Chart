<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Wars Navigation Chart</title>

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

    <!-- Turf.js -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <!-- Custom styles -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="./style.css" type="text/css">
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search a system" onmouseover="showTooltip(event, 'Search for a system')" onmouseout="hideTooltip()">
        <button id="search-button" onmouseover="showTooltip(event, 'Search for a system')" onmouseout="hideTooltip()">Search</button>
        <div class="toggle-background-container">
            <button id="toggle-background" onmouseover="showTooltip(event, 'Switch the background')" onmouseout="hideTooltip()"><i class="fas fa-star"></i></button>
        </div>
    </div>

    <div id="info-tooltip" class="info-tooltip"></div>

    <script src="tools/search.js"></script>
    <script>
        var map;
        var allFeatures = []; // To store all features from systems.geojson

        mapboxgl.accessToken = 'pk.eyJ1IjoibmVzcCIsImEiOiJjbHg1dDE5Mm4xY2h5Mmlxc2R2Mm95Y3ByIn0.Kp1Lcr9XD_u6oy8QOpvOZQ';

        // Load the external layers list
        fetch('./layers/layers.json')
            .then(response => response.json())
            .then(layers => initializeMap(layers))
            .catch(error => console.error('Error loading layers:', error));

        function initializeMap(layers) {
            map = new mapboxgl.Map({
                container: 'map',
                style: {
                    version: 8,
                    sources: layers.sources,
                    layers: layers.layers
                },
                center: [0.00847486, -0.0109944],
                zoom: 18
            });

            map.on('load', function() {
                // Load all features from the systems.geojson
                fetch('./layers/systems.geojson')
                    .then(response => response.json())
                    .then(data => {
                        allFeatures = data.features;

                        // Add a layer to the map to display the systems
                        map.addLayer({
                            'id': 'systems-layer',
                            'type': 'circle',
                            'source': {
                                'type': 'geojson',
                                'data': data
                            },
                            'paint': {
                                'circle-radius': 6,
                                'circle-color': 'rgba(255, 0, 0, 0)' // Transparent points
                            }
                        });

                        // Event listeners for hovering over the systems
                        map.on('mousemove', 'systems-layer', function(e) {
                            var feature = e.features[0];
                            var properties = feature.properties;
                            var infoTooltip = document.getElementById('info-tooltip');

                            var imageTag = properties.picture ? `<img src="${properties.picture}" alt="System Image" style="width: 100px; height: auto;">` : '';
                            var tooltipContent = `<strong>${properties.NAME}</strong><br>${properties.url_wookie ? `<a href="${properties.url_wookie}" target="_blank">More Info</a>` : ''}<br>${imageTag}`;

                            infoTooltip.innerHTML = tooltipContent;
                            infoTooltip.style.display = 'block';
                            infoTooltip.style.left = (e.originalEvent.pageX + 15) + 'px';
                            infoTooltip.style.top = (e.originalEvent.pageY + 15) + 'px';
                        });

                        map.on('mouseleave', 'systems-layer', function() {
                            var infoTooltip = document.getElementById('info-tooltip');
                            infoTooltip.style.display = 'none';
                        });
                    })
                    .catch(error => {
                        console.error('Error loading systems data:', error);
                    });
            });

            // Toggle background functionality
            var currentBackground = 'space-background';

            document.getElementById('toggle-background').addEventListener('click', function() {
                var newBackground = currentBackground === 'space-background' ? 'white-background' : 'space-background';
                map.setLayoutProperty(currentBackground, 'visibility', 'none');
                map.setLayoutProperty(newBackground, 'visibility', 'visible');
                currentBackground = newBackground;
            });
        }

        var tooltip = document.createElement('div');
        tooltip.setAttribute('class', 'tooltip');
        document.body.appendChild(tooltip);

        function showTooltip(event, message) {
            tooltip.innerHTML = message;
            tooltip.style.left = event.pageX + 'px';
            tooltip.style.top = event.pageY + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
        }
    </script>
</body>
</html>
