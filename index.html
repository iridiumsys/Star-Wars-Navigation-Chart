<!DOCTYPE html>
<html>
<head>
    <title>Star Wars Navigation Chart</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

    <!-- Turf.js -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <!-- Custom styles -->
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="./style.css" type="text/css">
</head>
<body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search a system">
        <button id="search-button">Search</button>
    </div>
    <div class="toggle-background-container">
        <button id="toggle-background"><i class="fas fa-star"></i></button>
    </div>
    <div class="toggle-routing-container">
        <button id="toggle-routing"><i class="fas fa-route"></i></button>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibmVzcCIsImEiOiJjbHg1dDE5Mm4xY2h5Mmlxc2R2Mm95Y3ByIn0.Kp1Lcr9XD_u6oy8QOpvOZQ';

        var map = new mapboxgl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'space-background': {
                        type: 'raster',
                        tiles: ['./XYZ_Space/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        minzoom: 16,
                        maxzoom: 22
                    },
                    'white-background': {
                        type: 'raster',
                        tiles: ['./XYZ/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        minzoom: 16,
                        maxzoom: 22
                    },
                    'systems': {
                        type: 'geojson',
                        data: './layers/systems.geojson'
                    },
                    'routes': {
                        type: 'geojson',
                        data: './layers/routes.geojson'
                    }
                },
                layers: [
                    {
                        id: 'space-background',
                        type: 'raster',
                        source: 'space-background',
                        layout: { visibility: 'visible' }
                    },
                    {
                        id: 'white-background',
                        type: 'raster',
                        source: 'white-background',
                        layout: { visibility: 'none' }
                    },
                    {
                        id: 'systems',
                        type: 'circle',
                        source: 'systems',
                        paint: {
                            'circle-radius': 5,
                            'circle-color': '#f00',
                            'circle-opacity': 0 // Initially hidden
                        }
                    },
                    {
                        id: 'routes',
                        type: 'line',
                        source: 'routes',
                        paint: {
                            'line-color': '#000',
                            'line-opacity': 0 // Initially hidden
                        }
                    },
                    {
                        id: 'route-line',
                        type: 'line',
                        source: {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: []
                            }
                        },
                        paint: {
                            'line-color': '#00f',
                            'line-width': 4
                        }
                    }
                ]
            },
            center: [0.00847486, -0.0109944],
            zoom: 18
        });

        var allFeatures = [];

        // Load all features from the systems.geojson
        fetch('./layers/systems.geojson')
            .then(response => response.json())
            .then(data => {
                allFeatures = data.features;
            });

        // Toggle background functionality
        var currentBackground = 'space-background';

        document.getElementById('toggle-background').addEventListener('click', function() {
            var newBackground = currentBackground === 'space-background' ? 'white-background' : 'space-background';
            map.setLayoutProperty(currentBackground, 'visibility', 'none');
            map.setLayoutProperty(newBackground, 'visibility', 'visible');
            currentBackground = newBackground;
        });

        // Search functionality
        document.getElementById('search-button').addEventListener('click', function() {
            const searchInput = document.getElementById('search-input').value.trim();
            if (!searchInput) {
                alert('Please enter a system name');
                return;
            }

            const searchWords = searchInput.toLowerCase().split(' ');

            let foundFeature = null;

            for (const feature of allFeatures) {
                const featureName = feature.properties.NAME;
                if (!featureName) continue;
                const nameWords = featureName.toLowerCase().split(' ');

                const allWordsMatch = searchWords.every(searchWord =>
                    nameWords.some(nameWord => nameWord.includes(searchWord))
                );

                if (allWordsMatch) {
                    foundFeature = feature;
                    break;
                }
            }

            if (foundFeature) {
                const coordinates = foundFeature.geometry.coordinates;
                map.flyTo({ center: coordinates, zoom: 20 });
            } else {
                alert('System not found');
                map.setZoom(18); // Reset zoom if not found
            }
        });

        var startPoint, endPoint;
        var routingActive = false;

        document.getElementById('toggle-routing').addEventListener('click', function() {
            routingActive = !routingActive;
            this.style.backgroundColor = routingActive ? '#79aaca' : 'rgba(0, 0, 0, 0.8)';
            if (routingActive) {
                map.once('click', function(event) {
                    startPoint = [event.lngLat.lng, event.lngLat.lat];
                    console.log('Start node:', startPoint);

                    map.once('click', function(event) {
                        endPoint = [event.lngLat.lng, event.lngLat.lat];
                        console.log('End node:', endPoint);
                        calculateAndDisplayRoute();
                    });
                });
            }
        });

        function calculateAndDisplayRoute() {
            if (!startPoint || !endPoint) {
                alert('Please select both start and end points.');
                return;
            }

            // Load route GeoJSON data
            fetch('./layers/routes.geojson')
                .then(response => response.json())
                .then(routeData => {
                    // Create Turf.js line segments from route GeoJSON
                    var lineSegments = routeData.features.map(feature => {
                        return feature.geometry.coordinates;
                    });

                    // Find the shortest path
                    var shortestPath = turf.shortestPath(startPoint, endPoint, {
                        units: 'kilometers',
                        path: lineSegments
                    });

                    if (!shortestPath) {
                        alert('No route found between the selected points.');
                        return;
                    }

                    map.getSource('route-line').setData(shortestPath);
                })
                .catch(error => {
                    console.error('Error loading or processing route data:', error);
                    alert('Error loading route data');
                });
        }
    </script>
</body>
</html>
